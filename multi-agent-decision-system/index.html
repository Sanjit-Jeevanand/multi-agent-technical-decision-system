<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Technical Decision System â€” Live Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;450;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            950: '#020617',
                            900: '#0f172a',
                            850: '#0b1221',
                            800: '#1e293b',
                            750: '#162032',
                            700: '#334155',
                        },
                        violet: {
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        },
                        amber: {
                            450: '#f59e0b',
                        },
                        emerald: {
                            450: '#10b981',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(8px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(139, 92, 246, 0.2)' },
                            '100%': { boxShadow: '0 0 20px rgba(139, 92, 246, 0.4)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #020617;
            color: #e2e8f0;
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }
        
        .panel {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(51, 65, 85, 0.4);
            backdrop-filter: blur(12px);
        }
        
        .panel-elevated {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(139, 92, 246, 0.15);
            box-shadow: 0 0 40px -10px rgba(139, 92, 246, 0.1);
        }
        
        .agent-node {
            transition: all 0.3s ease;
        }
        
        .agent-node:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .agent-node.active {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }
        
        .agent-node.running {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .agent-node.completed {
            border-color: rgba(16, 185, 129, 0.6) !important;
            background: rgba(16, 185, 129, 0.1) !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        
        .agent-node.executing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            border-color: #fbbf24 !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        .agent-node.failed {
            border-color: #ef4444 !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)) !important;
        }
        
        .disagreement-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .synthesis-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(139, 92, 246, 0.02) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .critic-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.03) 0%, rgba(239, 68, 68, 0.01) 100%);
            border: 1px solid rgba(239, 68, 68, 0.15);
        }
        
        /* Selectable Critic Issues */
        .critic-issue-item {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .critic-issue-item:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            transform: translateX(3px);
        }
        
        .critic-issue-item.selected {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.4);
        }
        
        .critic-issue-item input[type="checkbox"] {
            margin-top: 2px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #10b981;
        }
        
        .critic-issue-content {
            flex: 1;
        }
        
        .critic-issue-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .agent-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .impact-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .impact-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .impact-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
        
        .impact-badge.low {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }
        
        .issue-text {
            color: #cbd5e1;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        
        .selection-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.8rem;
            color: #93c5fd;
        }
        
        .selection-info strong {
            color: #60a5fa;
            font-weight: 600;
        }
        
        .confidence-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            height: 4px;
            border-radius: 2px;
            position: relative;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        
        .code-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: #64748b;
            transition: color 0.2s;
        }
        
        .code-ref:hover {
            color: #a78bfa;
        }
        
        .rejected-pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.6);
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .rejected-pill:hover {
            border-color: rgba(139, 92, 246, 0.5);
            color: #e9d5ff;
        }

        .rejected-pill.selected {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.6);
            color: #fca5a5;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 border-b border-slate-800/50 bg-slate-950/90 backdrop-blur-xl">
        <div class="max-w-[1600px] mx-auto px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded bg-violet-600 flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <div>
                    <div class="font-mono text-xs font-semibold text-slate-200 tracking-wider">MULTI-AGENT SYSTEM</div>
                    <div class="text-[10px] text-slate-500 font-mono">Technical Decision Demo</div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-700">
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                    <span class="text-[10px] font-mono text-slate-400 uppercase tracking-wider">Disconnected</span>
                </div>
                <div id="costDisplay" class="text-[10px] text-slate-500 font-mono hidden">Cost: $0.00</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 pt-14">
        
        <!-- Decision Prompt Section -->
        <section class="border-b border-slate-800/50 bg-slate-950/30">
            <div class="max-w-[1400px] mx-auto px-6 py-8">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-semibold text-slate-100 mb-2">Submit Technical Decision</h1>
                    <p class="text-sm text-slate-500">Multiple agents will reason independently and disagree constructively</p>
                </div>

                <!-- Decision Input -->
                <div class="max-w-3xl mx-auto">
                    <div class="relative mb-4">
                        <textarea 
                            id="decisionInput"
                            class="w-full bg-slate-950/60 border border-slate-700/50 rounded-xl p-5 pr-16 text-slate-200 placeholder-slate-600 focus:outline-none focus:border-violet-500/50 focus:ring-1 focus:ring-violet-500/30 transition-all resize-none text-base leading-relaxed min-h-[120px]"
                            placeholder="What technical decision would you like the system to analyze?"
                        >Should we use batch or online inference for this ML system?</textarea>
                        <button id="runBtn" onclick="runDecision()" class="absolute bottom-4 right-4 px-4 py-2 bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium rounded-lg transition-all flex items-center gap-2">
                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                            Run Decision
                        </button>
                    </div>

                    <!-- Options -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Option A</label>
                            <input 
                                type="text" 
                                id="optionA" 
                                value="batch inference"
                                class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-violet-500/50"
                            />
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Option B</label>
                            <input 
                                type="text" 
                                id="optionB" 
                                value="online inference"
                                class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-violet-500/50"
                            />
                        </div>
                    </div>

                    <!-- Constraints -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Latency Sensitivity</label>
                            <select id="latency" class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 focus:outline-none focus:border-violet-500/50">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Team Size</label>
                            <select id="teamSize" class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 focus:outline-none focus:border-violet-500/50">
                                <option value="small" selected>Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Risk Tolerance</label>
                            <select id="riskTolerance" class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 focus:outline-none focus:border-violet-500/50">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Budget</label>
                            <select id="budget" class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 focus:outline-none focus:border-violet-500/50">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Agent Workflow Graph -->
        <section class="border-b border-slate-800/50">
            <div class="max-w-[1600px] mx-auto px-6 py-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-slate-200">Agent Execution Graph</h2>
                    <span class="text-[10px] text-slate-500 font-mono">Parallel execution enforces independent reasoning</span>
                </div>

                <div class="panel rounded-xl p-6 overflow-x-auto">
                    <div class="min-w-max flex items-center gap-4">
                        
                        <!-- Planner -->
                        <div id="agent-planner" class="agent-node w-32 p-3 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('planner')">
                            <div class="w-8 h-8 mx-auto mb-2 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            </div>
                            <p class="text-[10px] font-medium text-slate-300">Planner</p>
                            <p class="text-[9px] text-slate-500 mt-1">Decomposes</p>
                        </div>

                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>

                        <!-- Parallel Specialists -->
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-2">
                                <div id="agent-systems" class="agent-node w-28 p-2 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('systems')">
                                    <div class="w-6 h-6 mx-auto mb-1 rounded bg-slate-800 flex items-center justify-center">
                                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>
                                    </div>
                                    <p class="text-[9px] font-medium text-slate-300">Systems</p>
                                </div>
                                <div id="agent-ml_ai" class="agent-node w-28 p-2 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('ml_ai')">
                                    <div class="w-6 h-6 mx-auto mb-1 rounded bg-slate-800 flex items-center justify-center">
                                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                                    </div>
                                    <p class="text-[9px] font-medium text-slate-300">ML/AI</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="agent-cost" class="agent-node w-28 p-2 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('cost')">
                                    <div class="w-6 h-6 mx-auto mb-1 rounded bg-slate-800 flex items-center justify-center">
                                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <p class="text-[9px] font-medium text-slate-300">Cost</p>
                                </div>
                                <div id="agent-product" class="agent-node w-28 p-2 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('product')">
                                    <div class="w-6 h-6 mx-auto mb-1 rounded bg-slate-800 flex items-center justify-center">
                                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                                    </div>
                                    <p class="text-[9px] font-medium text-slate-300">Product</p>
                                </div>
                            </div>
                        </div>

                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>

                        <!-- Disagreement Detector -->
                        <div id="agent-detector" class="agent-node w-32 p-3 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('detector')">
                            <div class="w-8 h-8 mx-auto mb-2 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            </div>
                            <p class="text-[10px] font-medium text-slate-300">Detector</p>
                            <p class="text-[9px] text-slate-500 mt-1">Finds conflicts</p>
                        </div>

                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>

                        <!-- Critic -->
                        <div id="agent-critic" class="agent-node w-28 p-3 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('critic')">
                            <div class="w-8 h-8 mx-auto mb-2 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            </div>
                            <p class="text-[10px] font-medium text-slate-300">Critic</p>
                            <p class="text-[9px] text-slate-500 mt-1">Challenges</p>
                        </div>

                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>

                        <!-- Synthesizer -->
                        <div id="agent-synthesizer" class="agent-node w-32 p-3 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('synthesizer')">
                            <div class="w-8 h-8 mx-auto mb-2 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            </div>
                            <p class="text-[10px] font-medium text-slate-300">Synthesizer</p>
                            <p class="text-[9px] text-slate-500 mt-1">Resolves</p>
                        </div>

                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>

                        <!-- Confidence Gate -->
                        <div id="agent-gate" class="agent-node w-28 p-3 rounded-lg border border-slate-700 bg-slate-900/50 text-center cursor-pointer" onclick="showAgentDetails('gate')">
                            <div class="w-8 h-8 mx-auto mb-2 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <p class="text-[10px] font-medium text-slate-300">Gate</p>
                            <p class="text-[9px] text-slate-500 mt-1">Validates</p>
                        </div>
                    </div>

                    <!-- Agent Details Panel -->
                    <div id="agentDetailsPanel" class="mt-6 p-4 rounded-lg bg-slate-950/50 border border-slate-800 hidden animate-fade-in">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-200" id="agentDetailName">Agent Name</h3>
                                <p class="text-xs text-slate-500" id="agentDetailRole">Role description</p>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-slate-500 font-mono block" id="agentDetailModel">GPT-5-mini</span>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-[10px] font-mono text-slate-500 uppercase tracking-wider mb-2">Input Context</h4>
                                <div class="p-2 rounded bg-slate-900/80 border border-slate-800 max-h-64 overflow-y-auto">
                                    <pre class="text-[10px] text-slate-400 overflow-x-auto whitespace-pre-wrap" id="agentInputSchema">No input data available yet</pre>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-[10px] font-mono text-slate-500 uppercase tracking-wider mb-2">Output Data</h4>
                                <div class="p-2 rounded bg-slate-900/80 border border-slate-800 max-h-64 overflow-y-auto">
                                    <pre class="text-[10px] text-slate-400 overflow-x-auto whitespace-pre-wrap" id="agentOutputSchema">No output data available yet</pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex items-center justify-between">
                            <span class="code-ref cursor-pointer hover:text-violet-400" id="agentCodeRef">src/agents/agent.py</span>
                            <span class="text-[10px] text-slate-600">Agent executed independently</span>
                        </div>
                    </div>

                    <!-- Execution Stats -->
                    <div id="executionStats" class="mt-6 p-4 rounded-lg bg-slate-950/50 border border-slate-800 hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-xs text-slate-400">Total Tokens:</span>
                                <span class="text-sm font-semibold text-slate-200 ml-2" id="totalTokens">0</span>
                            </div>
                            <div>
                                <span class="text-xs text-slate-400">Total Cost:</span>
                                <span class="text-sm font-semibold text-slate-200 ml-2">$<span id="totalCost">0.00</span></span>
                            </div>
                            <div>
                                <span class="text-xs text-slate-400">Status:</span>
                                <span class="text-sm font-semibold ml-2" id="executionStatus">Idle</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Agent Outputs -->
    <div class="max-w-[1600px] mx-auto px-6 py-6 grid lg:grid-cols-2 gap-6">
        
        <!-- Agent Outputs Panel (LEFT COLUMN) -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-sm font-semibold text-slate-200">Live Agent Reasoning</h2>
                <span class="text-[10px] text-slate-500 font-mono">Updates as agents complete</span>
            </div>

            <div id="agentOutputs" class="space-y-3 max-h-[600px] overflow-y-auto">
                <div class="p-8 text-center text-slate-600 text-sm">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    <p>Submit a decision prompt to observe agent reasoning</p>
                </div>
            </div>

            <!-- Disagreement Detection (MOVED TO LEFT COLUMN) -->
            <div id="disagreementPanel" class="hidden">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="text-sm font-semibold text-amber-400">Detected Disagreement</h2>
                </div>
                
                <div id="disagreementContent" class="disagreement-card rounded-xl p-4 space-y-3">
                </div>
            </div>
        </div>

        <!-- Synthesis & Controls Panel (RIGHT COLUMN) -->
        <div class="space-y-4">
            
            <!-- Critic Panel -->
            <div id="criticPanel" class="hidden">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="text-sm font-semibold text-red-400">Critic Analysis</h2>
                    <span class="text-[10px] text-slate-500 ml-auto">Select risks to accept</span>
                </div>
                
                <div id="criticContent" class="critic-card rounded-xl p-4 space-y-3">
                </div>
                
                <div id="selectedRisksInfo" class="selection-info hidden">
                    <strong>Selected Risks to Accept:</strong> <span id="selectedCount">0</span> issue(s)
                </div>
            </div>

            <!-- Synthesis Panel -->
            <div id="synthesisPanel" class="hidden">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    <h2 class="text-sm font-semibold text-violet-400">Final Synthesis</h2>
                </div>
                
                <div id="synthesisContent" class="synthesis-card rounded-xl p-4 space-y-4">
                </div>
            </div>

            <!-- Iteration 2 Controls -->
            <div id="iteration2Controls" class="hidden">
                <div class="border-t-2 border-dashed border-violet-500/30 pt-6 mt-6">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <h2 class="text-sm font-semibold text-violet-400">Iteration 2 Feedback</h2>
                    </div>
                    
                    <p class="text-xs text-slate-500 mb-4">
                        Review the critic's issues above and select which risks you're willing to accept.
                    </p>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-2 block">
                                Rejected Recommendations
                            </label>

                            <div id="rejectedOptions" class="flex flex-wrap gap-2">
                                <button type="button" class="rejected-pill" data-value="option_a">
                                    Option A
                                </button>
                                <button type="button" class="rejected-pill" data-value="option_b">
                                    Option B
                                </button>
                                <button type="button" class="rejected-pill" data-value="hybrid">
                                    Hybrid
                                </button>
                                <button type="button" class="rejected-pill" data-value="defer">
                                    Defer
                                </button>
                                <button type="button" class="rejected-pill" data-value="other">
                                    Other
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase mb-1 block">Additional Notes</label>
                            <textarea 
                                id="notes" 
                                class="w-full bg-slate-950/60 border border-slate-700/50 rounded-lg p-2.5 text-sm text-slate-200 placeholder-slate-600 focus:outline-none focus:border-violet-500/50 resize-none"
                                rows="2"
                                placeholder="Additional context..."
                            ></textarea>
                        </div>
                        
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="forceApprove" class="rounded border-slate-700 bg-slate-800 text-violet-600 focus:ring-violet-500/50">
                            <span class="text-xs text-slate-400">Force Approve (Override Gate)</span>
                        </label>
                        
                        <button onclick="submitIteration2()" class="w-full px-4 py-2.5 bg-violet-600 hover:bg-violet-500 text-white text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Run Iteration 2
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </main>

    <script>
        let ws = null;
        let currentState = {
            iteration: 0,
            agents: [],
            total_cost: 0,
            total_tokens: 0
        };
        
        // Track which agents are currently executing to prevent batch updates
        let executingAgents = new Set();
        
        // Track critic issues and selected risks
        let criticIssues = [];
        let selectedRisks = new Set();
        // Track rejected recommendations (iteration 2)
        let rejectedSelections = new Set();
        
        // Agent metadata
        const agentMetadata = {
            planner: {
                name: 'Planner Agent',
                role: 'Decomposes complex decisions into sub-questions for specialist agents',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/planner_agent.py'
            },
            systems: {
                name: 'Systems Agent',
                role: 'Evaluates infrastructure, scalability, and operational concerns',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/systems_agent.py'
            },
            ml_ai: {
                name: 'ML/AI Agent',
                role: 'Assesses ML feasibility, model complexity, and training requirements',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/ml_ai_agent.py'
            },
            cost: {
                name: 'Cost Agent',
                role: 'Analyzes financial implications and ROI considerations',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/cost_agent.py'
            },
            product: {
                name: 'Product Agent',
                role: 'Evaluates user experience, market fit, and feature value',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/product_agent.py'
            },
            detector: {
                name: 'Disagreement Detector',
                role: 'Identifies conflicts and inconsistencies between specialist recommendations',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/detector_agent.py'
            },
            critic: {
                name: 'Critic Agent',
                role: 'Challenges assumptions and identifies gaps in reasoning',
                model: 'GPT-5-mini',
                codeRef: 'src/agents/critic_agent.py'
            },
            synthesizer: {
                name: 'Synthesizer Agent',
                role: 'Integrates all perspectives into a final recommendation',
                model: 'GPT-5.1',
                codeRef: 'src/agents/synthesizer_agent.py'
            },
            gate: {
                name: 'Confidence Gate',
                role: 'Validates decision quality and determines if approval criteria are met',
                model: 'Rule Based',
                codeRef: 'src/agents/gate_agent.py'
            }
        };

        // Store agent inputs and outputs separately
        let agentInputs = {};
        let agentOutputs = {};

        function showAgentDetails(agentName) {
            const metadata = agentMetadata[agentName];
            if (!metadata) return;

            document.getElementById('agentDetailName').textContent = metadata.name;
            document.getElementById('agentDetailRole').textContent = metadata.role;
            document.getElementById('agentDetailModel').textContent = metadata.model;
            
            // Show actual input if available
            if (agentInputs[agentName]) {
                document.getElementById('agentInputSchema').textContent = JSON.stringify(agentInputs[agentName], null, 2);
            } else {
                document.getElementById('agentInputSchema').textContent = 'No input data available yet';
            }
            
            // Show actual output if available
            if (agentOutputs[agentName]) {
                document.getElementById('agentOutputSchema').textContent = JSON.stringify(agentOutputs[agentName], null, 2);
            } else {
                document.getElementById('agentOutputSchema').textContent = 'No output data available yet';
            }
            
            document.getElementById('agentCodeRef').textContent = metadata.codeRef;
            document.getElementById('agentDetailsPanel').classList.remove('hidden');
        }

        // FIXED: Only modify the specific agent, don't clear all others
        function setAgentState(agentName, state) {
            const element = document.getElementById(`agent-${agentName}`);
            if (!element) return;

            // Only remove states from THIS element, not all elements
            element.classList.remove('executing', 'completed', 'failed');
            if (state) {
                element.classList.add(state);
            }
        }

        function completeAgent(agentName) {
            const element = document.getElementById(`agent-${agentName}`);
            if (!element) return;
            
            element.classList.remove('executing', 'running');
            element.classList.add('completed');
            executingAgents.delete(agentName);
        }

        function updateExecutionStats(tokens, cost, status) {
            document.getElementById('totalTokens').textContent = tokens.toLocaleString();
            document.getElementById('totalCost').textContent = cost.toFixed(4);
            
            const statusEl = document.getElementById('executionStatus');
            statusEl.textContent = status;
            statusEl.className = 'text-sm font-semibold ml-2';
            
            if (status.includes('Running')) {
                statusEl.classList.add('text-amber-400');
            } else if (status.includes('Complete')) {
                statusEl.classList.add('text-green-400');
            } else if (status === 'Failed') {
                statusEl.classList.add('text-red-400');
            } else {
                statusEl.classList.add('text-slate-400');
            }

            document.getElementById('executionStats').classList.remove('hidden');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                    <span class="text-[10px] font-mono text-slate-400 uppercase tracking-wider">Connected</span>
                `;
            } else {
                status.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                    <span class="text-[10px] font-mono text-slate-400 uppercase tracking-wider">Disconnected</span>
                `;
            }
        }

        function updateCostDisplay() {
            const costEl = document.getElementById('costDisplay');
            costEl.textContent = `Cost: $${currentState.total_cost.toFixed(4)}`;
            costEl.classList.remove('hidden');
        }

        function toggleRiskSelection(index) {
            const item = document.getElementById(`issue-${index}`);
            const checkbox = document.getElementById(`checkbox-${index}`);
            
            if (selectedRisks.has(index)) {
                selectedRisks.delete(index);
                item.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedRisks.add(index);
                item.classList.add('selected');
                checkbox.checked = true;
            }
            
            updateSelectedRisksInfo();
        }

        function updateSelectedRisksInfo() {
            const info = document.getElementById('selectedRisksInfo');
            const count = document.getElementById('selectedCount');
            
            if (selectedRisks.size > 0) {
                count.textContent = selectedRisks.size;
                info.classList.remove('hidden');
            } else {
                info.classList.add('hidden');
            }
        }

        function initRejectedOptions() {
            document.querySelectorAll('.rejected-pill').forEach(btn => {
                btn.onclick = () => {
                    const value = btn.dataset.value;

                    if (rejectedSelections.has(value)) {
                        rejectedSelections.delete(value);
                        btn.classList.remove('selected');
                    } else {
                        rejectedSelections.add(value);
                        btn.classList.add('selected');
                    }
                };
            });
        }

        function resetUI() {
            document.querySelectorAll('.agent-node').forEach(n => {
                n.classList.remove('active', 'running', 'completed', 'executing', 'failed');
            });
            document.getElementById('agentOutputs').innerHTML = `
                <div class="p-8 text-center text-slate-600 text-sm">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    <p>Submit a decision prompt to observe agent reasoning</p>
                </div>
            `;
            document.getElementById('disagreementPanel').classList.add('hidden');
            document.getElementById('criticPanel').classList.add('hidden');
            document.getElementById('synthesisPanel').classList.add('hidden');
            document.getElementById('iteration2Controls').classList.add('hidden');
            document.getElementById('agentDetailsPanel').classList.add('hidden');
            document.getElementById('executionStats').classList.add('hidden');
            
            agentInputs = {};
            agentOutputs = {};
            executingAgents.clear();
            criticIssues = [];
            selectedRisks.clear();
            currentState = {
                iteration: 0,
                agents: [],
                total_cost: 0,
                total_tokens: 0
            };
            updateCostDisplay();
        }

        function addAgentCard(agentName, data) {
            const container = document.getElementById('agentOutputs');
            
            // Remove placeholder if it exists
            const placeholder = container.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const card = document.createElement('div');
            card.className = 'animate-slide-up';
            
            const confidence = data.output?.confidence || 0;
            const recommendation = data.output?.recommendation || '';
            const confidenceColor = confidence > 0.8 ? 'text-emerald-400' : confidence > 0.7 ? 'text-amber-400' : 'text-slate-400';
            
            let contentHTML = '';
            
            if (agentName === 'planner') {
                contentHTML = `
                    <p class="text-xs text-slate-400 mb-2">Decomposed decision into specialized sub-questions</p>
                    <div class="text-[10px] text-slate-500">
                        ${data.output?.assumptions ? `<strong>Assumptions:</strong> ${data.output.assumptions.length} identified` : ''}
                    </div>
                `;
            } else if (['systems', 'ml_ai', 'cost', 'product'].includes(agentName)) {
                contentHTML = `
                    <div class="mb-2">
                        <span class="text-[10px] text-slate-500 uppercase">Recommends</span>
                        <p class="text-sm text-slate-200 font-medium">${recommendation}</p>
                    </div>
                    ${data.output?.benefits ? `
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${data.output.benefits.map(b => `<span class="px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-400 text-[9px] border border-emerald-500/20">${b}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${data.output?.risks ? `
                        <div class="flex flex-wrap gap-1">
                            ${data.output.risks.map(r => `<span class="px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 text-[9px] border border-red-500/20">${r}</span>`).join('')}
                        </div>
                    ` : ''}
                `;
            } else if (agentName === 'detector') {
                const conflicts = data.output?.conflicts || [];
                contentHTML = `
                    <p class="text-xs text-slate-400 mb-2">
                        ${conflicts.length > 0 ? `Found ${conflicts.length} conflict(s)` : 'No conflicts detected'}
                    </p>
                `;
            } else if (agentName === 'critic') {
                const issues = data.output?.issues || [];
                contentHTML = `
                    <p class="text-xs text-slate-400 mb-2">
                        ${issues.length > 0 ? `Raised ${issues.length} issue(s) - Select which risks to accept in the right panel â†’` : 'No issues identified'}
                    </p>
                `;
            } else if (agentName === 'synthesizer') {
                contentHTML = `
                    <div class="mb-2">
                        <span class="text-[10px] text-slate-500 uppercase">Final Recommendation</span>
                        <p class="text-sm text-violet-200 font-medium">${data.output?.final_recommendation || 'N/A'}</p>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-800">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-slate-800 flex items-center justify-center">
                                <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            </div>
                            <span class="text-xs font-medium text-slate-300">${agentName.replace('_', '/').toUpperCase()}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${confidence > 0 ? `<span class="text-[10px] ${confidenceColor} font-mono">${(confidence * 100).toFixed(0)}%</span>` : ''}
                            <span class="text-[10px] text-slate-600 font-mono">$${data.cost_usd.toFixed(4)}</span>
                        </div>
                    </div>
                    ${contentHTML}
                    <details class="mt-2">
                        <summary class="text-[10px] text-violet-400 cursor-pointer">View Full Output</summary>
                        <pre class="text-[9px] text-slate-500 mt-2 overflow-x-auto whitespace-pre-wrap">${JSON.stringify(data.output, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            container.appendChild(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function handleAgentCompleted(data) {
            // Store input and output for agent details panel
            if (data.input_context) {
                agentInputs[data.agent] = data.input_context;
            }
            if (data.output) {
                agentOutputs[data.agent] = data.output;
            }
            
            // Update stats
            currentState.total_cost += data.cost_usd;
            currentState.total_tokens += data.input_tokens + data.output_tokens;
            updateCostDisplay();
            updateExecutionStats(currentState.total_tokens, currentState.total_cost, 'Running');
            
            // Update UI - Mark THIS agent as complete (individually)
            addAgentCard(data.agent, data);
            completeAgent(data.agent);
            
            // Handle special agent outputs
            if (data.agent === 'detector' && data.output) {
                showDisagreement(data.output);
            } else if (data.agent === 'critic' && data.output) {
                showCritic(data.output);
            } else if (data.agent === 'synthesizer' && data.output) {
                showSynthesis(data.output);
            }
        }

        function showDisagreement(output) {
            const panel = document.getElementById('disagreementPanel');
            const content = document.getElementById('disagreementContent');
            
            const conflicts = output.conflicts || [];
            
            if (conflicts.length > 0) {
                content.innerHTML = conflicts.map(c => `
                    <div class="p-3 rounded-lg bg-slate-950/50 border border-amber-500/20">
                        <div class="flex items-start gap-2 mb-2">
                            <svg class="w-4 h-4 text-amber-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs text-slate-300">${c.agents_involved.join(', ')}</span>
                                    <span class="px-2 py-0.5 rounded bg-${c.severity === 'high' ? 'red' : c.severity === 'medium' ? 'amber' : 'slate'}-500/10 text-${c.severity === 'high' ? 'red' : c.severity === 'medium' ? 'amber' : 'slate'}-400 text-[9px] border border-${c.severity === 'high' ? 'red' : c.severity === 'medium' ? 'amber' : 'slate'}-500/20">${c.severity}</span>
                                </div>
                                <p class="text-xs text-slate-400">${c.description}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                panel.classList.remove('hidden');
            }
        }

        function showCritic(output) {
            const panel = document.getElementById('criticPanel');
            const content = document.getElementById('criticContent');
            
            const issues = output.issues || [];
            
            if (issues.length > 0) {
                criticIssues = issues;
                
                content.innerHTML = issues.map((issue, index) => `
                    <div id="issue-${index}" class="critic-issue-item" onclick="toggleRiskSelection(${index})">
                        <input type="checkbox" id="checkbox-${index}" onclick="event.stopPropagation(); toggleRiskSelection(${index})">
                        <div class="critic-issue-content">
                            <div class="critic-issue-header">
                                <span class="agent-badge">${issue.agent}</span>
                                <span class="impact-badge ${issue.impact}">${issue.impact.toUpperCase()}</span>
                            </div>
                            <div class="issue-text">${issue.issue}</div>
                        </div>
                    </div>
                `).join('');
                
                panel.classList.remove('hidden');
            }
        }

        function showSynthesis(output) {
            const panel = document.getElementById('synthesisPanel');
            const content = document.getElementById('synthesisContent');
            
            const rationale = output.rationale || [];
            const tradeoffs = output.tradeoffs || [];
            const risks = output.unresolved_risks || [];
            
            content.innerHTML = `
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-slate-200">${output.final_recommendation || 'N/A'}</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-500">Confidence</span>
                            <div class="w-24 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-violet-500 rounded-full" style="width: ${(output.confidence || 0) * 100}%"></div>
                            </div>
                            <span class="text-[10px] text-violet-400 font-mono">${((output.confidence || 0) * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                    
                    ${rationale.length > 0 ? `
                        <div class="mb-3">
                            <h4 class="text-[10px] font-mono text-slate-500 uppercase mb-2">Rationale</h4>
                            <ul class="space-y-1">
                                ${rationale.map(r => `<li class="text-xs text-slate-400">â€¢ ${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${tradeoffs.length > 0 ? `
                        <div class="mb-3">
                            <h4 class="text-[10px] font-mono text-slate-500 uppercase mb-2">Tradeoffs</h4>
                            <ul class="space-y-1">
                                ${tradeoffs.map(t => `<li class="text-xs text-slate-400">â€¢ ${t}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${risks.length > 0 ? `
                        <div>
                            <h4 class="text-[10px] font-mono text-slate-500 uppercase mb-2">Unresolved Risks</h4>
                            <div class="flex flex-wrap gap-2">
                                ${risks.map(risk => `<span class="px-2 py-1 rounded bg-amber-500/10 text-amber-400 text-[10px] border border-amber-500/20">${risk}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            panel.classList.remove('hidden');
        }

        
        function processSingleMessage(data) {
            console.log('Processing:', data.type, data.agent || '');
            
            if (data.type === 'state_initialized') {
                console.log('State initialized');
            } else if (data.type === 'agent_started') {
                executingAgents.add(data.agent);
                setAgentState(data.agent, 'executing');
            } else if (data.type === 'agent_completed') {
                handleAgentCompleted(data);
            } else if (data.type === 'iteration_complete') {
                updateExecutionStats(currentState.total_tokens, currentState.total_cost, `Iteration ${data.iteration} Complete`);
                if (!data.approved) {
                    document.getElementById('iteration2Controls').classList.remove('hidden');
                    initRejectedOptions();
                }
            } else if (data.type === 'authority_shift') {
                console.log('Authority shifted to:', data.gate_tier);
            } else if (data.type === 'run_complete') {
                updateExecutionStats(currentState.total_tokens, currentState.total_cost, 'Completed');
                console.log('Run complete:', data.final_recommendation);
            } else if (data.type === 'error') {
                updateExecutionStats(currentState.total_tokens, currentState.total_cost, 'Failed');
                console.error('Error:', data.message);
                alert('Error: ' + data.message);
            }
        }


        function runDecision() {
            resetUI();
            
            const wsUrl = `ws://localhost:8000/ws/full-trace`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateConnectionStatus(true);
                updateExecutionStats(0, 0, 'Running');
                
                const payload = {
                    type: 'start',
                    decision_question: document.getElementById('decisionInput').value,
                    options: {
                        option_a: document.getElementById('optionA').value,
                        option_b: document.getElementById('optionB').value,
                    },
                    constraints: {
                        latency_sensitivity: document.getElementById('latency').value,
                        team_size: document.getElementById('teamSize').value,
                        risk_tolerance: document.getElementById('riskTolerance').value,
                        budget_sensitivity: document.getElementById('budget').value,
                    },
                    force_approve: false,
                };
                
                ws.send(JSON.stringify(payload));
                currentState.iteration = 1;
            };
            
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);

                processSingleMessage(data);

                // Force browser paint boundary so agents light up sequentially
                await new Promise(requestAnimationFrame);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
                updateExecutionStats(currentState.total_tokens, currentState.total_cost, 'Failed');
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
            };
        }

        function submitIteration2() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected');
                return;
            }
            
            // Build accepted risks from selected checkboxes
            const acceptedRisks = Array.from(selectedRisks).map(index => {
                const issue = criticIssues[index];
                return `[${issue.agent}] ${issue.issue}`;
            });
            
            if (acceptedRisks.length === 0 && !document.getElementById('forceApprove').checked) {
                if (!confirm('No risks selected. Do you want to proceed without accepting any risks?')) {
                    return;
                }
            }
            
            const rejectedRecs = Array.from(rejectedSelections);
            
            const payload = {
                type: 'user_delta',
                accepted_risks: acceptedRisks,
                rejected_recommendations: rejectedRecs,
                notes: document.getElementById('notes').value,
                force_approve: document.getElementById('forceApprove').checked,
            };
            
            ws.send(JSON.stringify(payload));
            document.getElementById('iteration2Controls').classList.add('hidden');
            currentState.iteration = 2;
            
            // Clear selections
            selectedRisks.clear();
            criticIssues = [];
            rejectedSelections.clear();
            document.querySelectorAll('.rejected-pill').forEach(b => b.classList.remove('selected'));
        }
    </script>
</body>
</html>